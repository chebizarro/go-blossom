# Blossom Server - OpenAPI Integration

This repository implements a [Blossom](https://github.com/hzrd149/blossom) server for storing and retrieving blobs using the Blossom protocol. The core functionality is defined via an **OpenAPI v3 specification** which drives the development of the API and ensures consistency across the project.

This README focuses on how to generate Go code from the OpenAPI specification using **ogen-go** and integrate it into the project.

## Requirements

Before you begin, ensure you have the following tools installed:

- **Go**: [Install Go](https://golang.org/doc/install) if you don't have it.
- **ogen-go**: This is the Go code generator based on OpenAPI v3. Install it by running:

```bash
go install github.com/ogen-go/ogen/cmd/ogen@latest
```

## OpenAPI Specification

The core of this Blossom server is driven by an OpenAPI specification. The OpenAPI spec defines all the API operations, request/response structures, and types.

### Example OpenAPI Structure

The `openapi.yaml` file contains the full definition of the Blossom API. It specifies the endpoints such as:

- **GET** `/list/{pubkey}`: Retrieve a list of blobs uploaded by a user identified by their Nostr public key.
- **PUT** `/upload`: Upload a new blob, authorized with a Nostr event.
- **DELETE** `/{sha256}`: Delete a blob by its SHA256 hash.

Example snippet from the OpenAPI specification:

```yaml
openapi: 3.0.0
info:
  title: Blossom Server API
  version: 1.0.0
paths:
  /upload:
    put:
      summary: Upload a new blob
      requestBody:
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          description: Blob uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'

components:
  schemas:
    UploadResponse:
      type: object
      properties:
        url:
          type: string
        sha256:
          type: string
```

## Generating Code with `ogen-go`

Once your OpenAPI specification is ready, you can generate the Go code for the server-side API handlers and types using **ogen-go**.

### Steps to Generate Code

1. **Create/Open the OpenAPI spec (`openapi.yaml`)**: Ensure that the API endpoints, request/response bodies, and types are properly defined in the spec file.

2. **Run the code generator**: Use the following command to generate the Go server code from the OpenAPI spec:

```bash
go run github.com/ogen-go/ogen/cmd/ogen@latest --target internal/api --clean target-path
```

Here’s what each part of the command does:
- **`--target api`**: Specifies the target directory (`api/`) where the generated code will be placed.
- **`--package api`**: Defines the Go package name as `api`.
- **`openapi.yaml`**: This is your OpenAPI specification file.

### Generated Code

After running the command, **ogen-go** will generate a set of files in the `api/` directory:

- **`openapi_types.go`**: Contains Go structs, enums, and interfaces for the request/response bodies and parameters defined in the OpenAPI spec.
- **`handler.go`**: Defines the `Handler` interface that you need to implement for your API logic.
- **`router.go`** (if generated): A router that maps the API endpoints to the corresponding handler methods.

#### Example Generated Types

For the `/upload` endpoint, the generator will create types like:

```go
// UploadPutReq represents the request body for the PUT /upload operation.
type UploadPutReq struct {
    File io.Reader
}

// UploadPutRes represents the response body for the PUT /upload operation.
type UploadPutRes struct {
    URL    string `json:"url"`
    Sha256 string `json:"sha256"`
}
```

#### Example Generated Handler Interface

```go
type Handler interface {
    UploadPut(ctx context.Context, req UploadPutReq) (UploadPutRes, error)
    SHA256Delete(ctx context.Context, params SHA256DeleteParams) (SHA256DeleteRes, error)
}
```

You will need to implement the methods of this `Handler` interface in your application (e.g., `handlers.go`), where each method corresponds to an API operation.

## How to Use the Generated Code

1. **Implement the Handlers**: Implement the `Handler` interface generated by **ogen-go**. For example, you’ll need to write the logic for uploading and deleting blobs in the corresponding methods (e.g., `UploadPut`, `SHA256Delete`).

Example handler implementation:

```go
func (h *HandlerImpl) UploadPut(ctx context.Context, req UploadPutReq) (UploadPutRes, error) {
    // Logic to save the uploaded blob and return the response
    // Save the file, generate the SHA-256, return the URL
}
```

2. **Initialize the Router and Start the Server**: Once you’ve implemented the handlers, you can set up the router and start the HTTP server.

Example:

```go
func main() {
    handler := &HandlerImpl{}
    router := api.NewRouter(handler) // Initialize router with your handler

    log.Fatal(http.ListenAndServe(":8080", router)) // Start the server
}
```

## Conclusion

With **ogen-go**, you can easily generate the Go code required to implement your API endpoints based on the OpenAPI specification. This makes it much easier to maintain consistency and rapidly prototype or implement changes as the API evolves.

The next steps are to implement your business logic in the generated handler methods and build out the rest of the server components. We'll cover those details in a future update of this README.
